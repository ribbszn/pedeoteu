<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üî• Teste Firebase - Ribbs ZN</title>
    <style>
      body {
        font-family: monospace;
        background: #121212;
        color: #fff;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      button {
        background: #ffd500;
        color: #000;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        margin: 10px 5px;
      }
      button:hover {
        background: #ffdf33;
      }
      #log {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        max-height: 500px;
        overflow-y: auto;
      }
      .success {
        color: #2ecc71;
      }
      .error {
        color: #e74c3c;
      }
      .info {
        color: #3498db;
      }
      .warning {
        color: #f39c12;
      }
      pre {
        background: #0a0a0a;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>üî• Teste de Integra√ß√£o Firebase - Ribbs ZN</h1>

    <div>
      <button onclick="testeConexao()">1Ô∏è‚É£ Testar Conex√£o</button>
      <button onclick="testeEscrita()">2Ô∏è‚É£ Enviar Pedido Teste</button>
      <button onclick="testeLeitura()">3Ô∏è‚É£ Ler Pedidos</button>
      <button onclick="limparLog()">üßπ Limpar Log</button>
    </div>

    <div id="log"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
      const logEl = document.getElementById("log");
      let db = null;

      function addLog(msg, type = "info") {
        const time = new Date().toLocaleTimeString("pt-BR");
        const p = document.createElement("p");
        p.className = type;
        p.innerHTML = `[${time}] ${msg}`;
        logEl.appendChild(p);
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
      }

      function limparLog() {
        logEl.innerHTML = "";
      }

      // INICIALIZA√á√ÉO
      try {
        addLog("üîß Inicializando Firebase...", "info");

        if (typeof firebase === "undefined") {
          addLog(
            "‚ùå ERRO: Firebase n√£o carregado! Scripts n√£o est√£o funcionando.",
            "error",
          );
        } else {
          addLog("‚úÖ Firebase SDK carregado com sucesso", "success");

          const firebaseConfig = {
            apiKey: "AIzaSyDFFbaZmX80QezLfozPAIaIGEhIJm9z43E",
            authDomain: "ribbsznmesas.firebaseapp.com",
            databaseURL: "https://ribbsznmesas-default-rtdb.firebaseio.com",
            projectId: "ribbsznmesas",
            storageBucket: "ribbsznmesas.firebasestorage.app",
            messagingSenderId: "970185571294",
            appId: "1:970185571294:web:25e8552bd72d852283bb4f",
          };

          firebase.initializeApp(firebaseConfig);
          db = firebase.database();

          addLog("‚úÖ Firebase inicializado com sucesso!", "success");
          addLog("‚úÖ Database conectado: " + db.toString(), "success");
        }
      } catch (error) {
        addLog("‚ùå Erro ao inicializar Firebase: " + error.message, "error");
        addLog("Stack: " + error.stack, "error");
      }

      // TESTE 1: CONEX√ÉO
      function testeConexao() {
        addLog("", "info");
        addLog("====================================", "info");
        addLog("üß™ TESTE 1: Verificando Conex√£o", "info");
        addLog("====================================", "info");

        if (!db) {
          addLog("‚ùå Database n√£o inicializado", "error");
          return;
        }

        addLog("‚úÖ Database est√° inicializado", "success");
        addLog("üîç Tipo do objeto: " + typeof db, "info");
        addLog("üîç Tentando conectar ao caminho .info/connected...", "info");

        db.ref(".info/connected")
          .once("value")
          .then((snapshot) => {
            if (snapshot.val() === true) {
              addLog("‚úÖ CONECTADO ao Firebase Realtime Database!", "success");
            } else {
              addLog("‚ö†Ô∏è Desconectado do Firebase", "warning");
            }
          })
          .catch((error) => {
            addLog("‚ùå Erro ao verificar conex√£o: " + error.message, "error");
          });
      }

      // TESTE 2: ESCRITA
      async function testeEscrita() {
        addLog("", "info");
        addLog("====================================", "info");
        addLog("üß™ TESTE 2: Enviando Pedido Teste", "info");
        addLog("====================================", "info");

        if (!db) {
          addLog("‚ùå Database n√£o inicializado", "error");
          return;
        }

        try {
          const pedidoTeste = {
            tipo: "delivery",
            tipoOrigem: "delivery",
            status: "pending",
            nomeCliente: "TESTE INTEGRA√á√ÉO",
            cliente: "TESTE INTEGRA√á√ÉO",
            nome: "TESTE INTEGRA√á√ÉO",
            pagamento: "PIX",
            endereco: "TESTE - Integra√ß√£o Card√°pio Digital",
            itens: [
              {
                nome: "X-Bacon Teste",
                preco: 25.0,
                quantidade: 1,
                qtd: 1,
                observacao: "Tamanho: Grande | Este √© um pedido de teste",
              },
            ],
            total: 25.0,
            timestamp: Date.now(),
            dataHora: new Date().toLocaleString("pt-BR"),
          };

          addLog("üì¶ Pedido montado:", "info");
          addLog(
            "<pre>" + JSON.stringify(pedidoTeste, null, 2) + "</pre>",
            "info",
          );

          addLog("üöÄ Enviando para /pedidos/...", "info");
          const ref = db.ref("pedidos").push();

          addLog("üîë ID gerado: " + ref.key, "info");

          await ref.set(pedidoTeste);

          addLog("‚úÖ SUCESSO! Pedido enviado!", "success");
          addLog("üîç ID do pedido: " + ref.key, "success");
          addLog("üîç Caminho completo: /pedidos/" + ref.key, "info");
          addLog("", "info");
          addLog("üëÄ VERIFIQUE AGORA:", "warning");
          addLog("1. Abra o KDS (kds.html)", "warning");
          addLog("2. O pedido deve aparecer na coluna DELIVERY", "warning");
          addLog("3. Cliente: TESTE INTEGRA√á√ÉO", "warning");
          addLog("4. Status: PENDING (amarelo)", "warning");
        } catch (error) {
          addLog("‚ùå ERRO ao enviar: " + error.message, "error");
          addLog("Stack: " + error.stack, "error");

          if (error.message.includes("PERMISSION_DENIED")) {
            addLog("", "error");
            addLog("‚ö†Ô∏è PROBLEMA: Permiss√£o negada!", "error");
            addLog("SOLU√á√ÉO:", "warning");
            addLog(
              "1. Acesse: https://console.firebase.google.com/",
              "warning",
            );
            addLog('2. Selecione o projeto "ribbsznmesas"', "warning");
            addLog("3. V√° em Realtime Database ‚Üí Regras", "warning");
            addLog("4. Configure as regras assim:", "warning");
            addLog("<pre>{</pre>", "warning");
            addLog('<pre>  "rules": {</pre>', "warning");
            addLog(
              '<pre>    "pedidos": { ".read": true, ".write": true },</pre>',
              "warning",
            );
            addLog(
              '<pre>    "historico": { ".read": true, ".write": true }</pre>',
              "warning",
            );
            addLog("<pre>  }</pre>", "warning");
            addLog("<pre>}</pre>", "warning");
          }
        }
      }

      // TESTE 3: LEITURA
      function testeLeitura() {
        addLog("", "info");
        addLog("====================================", "info");
        addLog("üß™ TESTE 3: Lendo Pedidos", "info");
        addLog("====================================", "info");

        if (!db) {
          addLog("‚ùå Database n√£o inicializado", "error");
          return;
        }

        addLog("üìñ Buscando pedidos em /pedidos/...", "info");

        db.ref("pedidos")
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val();

            if (!data) {
              addLog("‚ö†Ô∏è Nenhum pedido encontrado no banco", "warning");
              addLog('üí° Clique em "2Ô∏è‚É£ Enviar Pedido Teste" primeiro', "info");
              return;
            }

            const pedidos = Object.keys(data);
            addLog(
              "‚úÖ Encontrados " + pedidos.length + " pedido(s)",
              "success",
            );
            addLog("", "info");

            pedidos.forEach((id, index) => {
              const pedido = data[id];
              addLog("üì¶ Pedido " + (index + 1) + ":", "info");
              addLog("   ID: " + id, "info");
              addLog("   Cliente: " + pedido.nomeCliente, "info");
              addLog("   Status: " + pedido.status, "info");
              addLog("   Total: R$ " + pedido.total.toFixed(2), "info");
              addLog("   Itens: " + pedido.itens.length, "info");
              addLog("", "info");
            });

            addLog("üìä Dados completos:", "info");
            addLog("<pre>" + JSON.stringify(data, null, 2) + "</pre>", "info");
          })
          .catch((error) => {
            addLog("‚ùå Erro ao ler pedidos: " + error.message, "error");
          });
      }

      // Auto-executar teste de conex√£o
      window.addEventListener("load", () => {
        setTimeout(testeConexao, 500);
      });
    </script>
  </body>
</html>
