<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KDS - Ribbs ZN</title>
    <link rel="stylesheet" href="kds.css" />
    <style>
      /* Login Screen Styles */
      #login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      .login-container {
        background: #111;
        border: 2px solid #ffc107;
        border-radius: 20px;
        padding: 40px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 40px rgba(255, 193, 7, 0.3);
      }

      .login-logo {
        font-size: 2.5rem;
        font-weight: 900;
        color: #ffc107;
        margin-bottom: 10px;
        letter-spacing: 2px;
      }

      .login-title {
        color: #fff;
        font-size: 1.3rem;
        margin-bottom: 30px;
        font-weight: 600;
      }

      .pin-input-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 25px;
      }

      .pin-digit {
        width: 50px;
        height: 60px;
        font-size: 2rem;
        text-align: center;
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 10px;
        color: #ffc107;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .pin-digit:focus {
        outline: none;
        border-color: #ffc107;
        box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
      }

      .pin-digit.filled {
        background: #2a2a2a;
        border-color: #ffc107;
      }

      .login-btn {
        width: 100%;
        padding: 15px;
        background: #ffc107;
        color: #000;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      .login-btn:hover {
        background: #ffca28;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(255, 193, 7, 0.4);
      }

      .login-btn:active {
        transform: translateY(0);
      }

      .login-btn:disabled {
        background: #555;
        color: #888;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        color: #f44336;
        margin-top: 15px;
        font-size: 0.9rem;
        min-height: 20px;
      }

      .login-hint {
        color: #888;
        font-size: 0.85rem;
        margin-top: 20px;
      }

      /* Hide main content initially */
      .kds-header,
      .kds-sidebar,
      .kds-main {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="login-screen">
      <div class="login-container">
        <div class="login-logo">üî• RIBBS ZN</div>
        <h2 class="login-title">Insira a senha de 6 D√≠gitos</h2>

        <div class="pin-input-container">
          <input
            type="text"
            class="pin-digit"
            maxlength="1"
            data-index="0"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            class="pin-digit"
            maxlength="1"
            data-index="1"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            class="pin-digit"
            maxlength="1"
            data-index="2"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            class="pin-digit"
            maxlength="1"
            data-index="3"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            class="pin-digit"
            maxlength="1"
            data-index="4"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="text"
            class="pin-digit"
            maxlength="1"
            data-index="5"
            inputmode="numeric"
            pattern="[0-9]*"
          />
        </div>

        <button class="login-btn" id="login-submit-btn" disabled>ENTRAR</button>

        <div class="error-message" id="login-error"></div>
        <div class="login-hint">Digite o PIN de 6 d√≠gitos</div>
      </div>
    </div>

    <!-- Header -->
    <header class="kds-header">
      <div class="header-left">
        <h1>üî• RIBBS ZN - KDS</h1>
      </div>

      <div class="header-center">
        <div class="in-progress-widget" id="in-progress-widget">
          <div class="in-progress-header" id="in-progress-header">
            <span class="in-progress-icon">üë®‚Äçüç≥</span>
            <div class="in-progress-text">
              <span class="in-progress-label">Em Preparo</span>
              <span class="in-progress-count" id="in-progress-count">0</span>
            </div>
          </div>
          <div class="in-progress-dropdown" id="in-progress-dropdown">
            <div class="in-progress-list" id="in-progress-list">
              <div class="empty-state-inline">
                <p>Nenhum pedido em preparo</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <nav class="kds-sidebar">
      <div class="sidebar-top">
        <button class="sidebar-btn" id="btn-menu-management">
          <span class="sidebar-btn-icon">üìã</span>
          <span class="sidebar-btn-label">Gest√£o Card√°pio</span>
        </button>
        <button class="sidebar-btn" id="btn-ingredients-management">
          <span class="sidebar-btn-icon">ü•¨</span>
          <span class="sidebar-btn-label">Gest√£o Insumos</span>
        </button>
        <button class="sidebar-btn" id="btn-history">
          <span class="sidebar-btn-icon">üìú</span>
          <span class="sidebar-btn-label">Hist√≥rico</span>
        </button>
        <button class="sidebar-btn sound-toggle" id="btn-sound">
          <span class="sidebar-btn-icon">üîî</span>
          <span class="sidebar-btn-label" id="sound-status">Som: ON</span>
        </button>
      </div>
      <div class="sidebar-bottom">
        <div class="sidebar-status">
          <span class="status-dot" id="firebase-status"></span>
          <span class="sidebar-btn-label" id="status-text">Conectando...</span>
        </div>
        <button class="sidebar-btn sidebar-btn-logout" onclick="logoutKDS()">
          <span class="sidebar-btn-icon">üö™</span>
          <span class="sidebar-btn-label">Sair</span>
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="kds-main">
      <!-- Mesas/Totem -->
      <section class="order-column">
        <div class="column-header mesas">
          <h2>ü™ë Mesas / Totem</h2>
          <span class="order-count" id="mesas-count">0</span>
        </div>
        <div class="orders-container" id="mesas-container">
          <div class="empty-state">
            <p>Nenhum pedido de mesa/totem no momento</p>
          </div>
        </div>
      </section>

      <!-- Delivery -->
      <section class="order-column">
        <div class="column-header delivery">
          <h2>üõµ Delivery</h2>
          <span class="order-count" id="delivery-count">0</span>
        </div>
        <div class="orders-container" id="delivery-container">
          <div class="empty-state">
            <p>Nenhum pedido de delivery no momento</p>
          </div>
        </div>
      </section>
    </main>

    <!-- Sidebar Hist√≥rico -->
    <aside class="sidebar" id="history-sidebar">
      <div class="sidebar-header">
        <h2>üìú Hist√≥rico de Pedidos</h2>
        <button class="btn-close" id="close-history">&times;</button>
      </div>

      <div class="history-filters">
        <button class="filter-btn active" data-filter="all">Todos</button>
        <button class="filter-btn" data-filter="today">Hoje</button>
        <button class="filter-btn" data-filter="week">Semana</button>
      </div>

      <div class="sidebar-content" id="history-content">
        <div class="empty-state">
          <p>Nenhum pedido finalizado ainda</p>
        </div>
      </div>
    </aside>

    <!-- Modal Gest√£o de Card√°pio -->
    <div class="modal" id="menu-modal">
      <div class="modal-content menu-management">
        <div class="modal-header">
          <h2>üìã Gest√£o de Card√°pio</h2>
          <button class="btn-close" id="close-menu-modal">&times;</button>
        </div>

        <div class="menu-search">
          <input
            type="text"
            id="menu-search-input"
            placeholder="Buscar item no card√°pio..."
          />
        </div>

        <div class="menu-stats">
          <div class="stat-card">
            <span class="stat-label">Dispon√≠veis</span>
            <span class="stat-value available" id="available-count">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Indispon√≠veis</span>
            <span class="stat-value unavailable" id="unavailable-count">0</span>
          </div>
        </div>

        <div class="menu-categories" id="menu-categories">
          <!-- Categorias ser√£o carregadas aqui -->
        </div>
      </div>
    </div>

    <!-- Modal Gest√£o de Insumos -->
    <div class="modal" id="ingredients-modal">
      <div class="modal-content ingredients-management">
        <div class="modal-header">
          <h2>ü•¨ Gest√£o de Insumos</h2>
          <button class="btn-close" id="close-ingredients-modal">
            &times;
          </button>
        </div>

        <div class="ingredients-search">
          <input
            type="text"
            id="ingredients-search-input"
            placeholder="Buscar ingrediente ou adicional..."
          />
        </div>

        <div class="ingredients-stats">
          <div class="stat-card">
            <span class="stat-label">Dispon√≠veis</span>
            <span class="stat-value available" id="ingredients-available-count"
              >0</span
            >
          </div>
          <div class="stat-card">
            <span class="stat-label">Indispon√≠veis</span>
            <span
              class="stat-value unavailable"
              id="ingredients-unavailable-count"
              >0</span
            >
          </div>
        </div>

        <div class="ingredients-tabs">
          <button class="tab-btn active" data-tab="ingredients">
            Ingredientes
          </button>
          <button class="tab-btn" data-tab="paid-extras">
            Adicionais Pagos
          </button>
        </div>

        <div class="ingredients-content" id="ingredients-content">
          <!-- Ingredientes e adicionais ser√£o carregados aqui -->
        </div>
      </div>
    </div>

    <!-- Modal Detalhes do Pedido -->
    <div class="modal" id="order-detail-modal">
      <div class="modal-content order-detail">
        <div class="modal-header">
          <h2>Detalhes do Pedido</h2>
          <button class="btn-close" id="close-order-detail">&times;</button>
        </div>

        <div class="modal-body" id="order-detail-content">
          <!-- Conte√∫do ser√° carregado dinamicamente -->
        </div>
      </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Audio para notifica√ß√£o -->
    <audio id="notification-sound" preload="auto">
      <source
        src="data:audio/wav;base64,UklGRhwCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YfgBAAD/////AAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA/////wAAAAD//////////wAAAAD/////AAAA//////////8AAAAA/////wAAAAD//////////wAAAAD/////AAAA/v7+/v7+/v7+/v7+/v7+/v7+/v7+/g=="
        type="audio/wav"
      />
    </audio>

    <!-- Audio para beep de pedido pendente -->
    <audio id="beep-sound" preload="auto" loop>
      <source src="beep.mp3" type="audio/mpeg" />
    </audio>

    <!-- ================================================================
         LOGIN SCRIPT
         ================================================================ -->
    <script>
      // PIN Login Handler
      (function () {
        const pinInputs = document.querySelectorAll(".pin-digit");
        const submitBtn = document.getElementById("login-submit-btn");
        const errorDiv = document.getElementById("login-error");

        // Focus first input on load
        if (pinInputs.length > 0) {
          pinInputs[0].focus();
        }

        // Handle input in PIN fields
        pinInputs.forEach((input, index) => {
          // Only allow numbers
          input.addEventListener("input", (e) => {
            const value = e.target.value.replace(/[^0-9]/g, "");
            e.target.value = value;

            if (value) {
              e.target.classList.add("filled");
              // Move to next input
              if (index < pinInputs.length - 1) {
                pinInputs[index + 1].focus();
              }
            } else {
              e.target.classList.remove("filled");
            }

            // Check if all fields are filled
            const allFilled = Array.from(pinInputs).every((inp) => inp.value);
            submitBtn.disabled = !allFilled;
          });

          // Handle backspace
          input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && !e.target.value && index > 0) {
              pinInputs[index - 1].focus();
              pinInputs[index - 1].value = "";
              pinInputs[index - 1].classList.remove("filled");
            }

            // Handle Enter key
            if (e.key === "Enter") {
              e.preventDefault();
              const allFilled = Array.from(pinInputs).every((inp) => inp.value);
              if (allFilled) {
                handleLogin();
              }
            }
          });

          // Prevent paste of non-numeric
          input.addEventListener("paste", (e) => {
            e.preventDefault();
            const pastedText = (
              e.clipboardData || window.clipboardData
            ).getData("text");
            const digits = pastedText.replace(/[^0-9]/g, "").split("");

            digits.forEach((digit, i) => {
              if (index + i < pinInputs.length) {
                pinInputs[index + i].value = digit;
                pinInputs[index + i].classList.add("filled");
              }
            });

            // Focus appropriate input
            const nextIndex = Math.min(
              index + digits.length,
              pinInputs.length - 1,
            );
            pinInputs[nextIndex].focus();

            // Check if all filled
            const allFilled = Array.from(pinInputs).every((inp) => inp.value);
            submitBtn.disabled = !allFilled;
          });
        });

        // Handle login submission
        async function handleLogin() {
          const pin = Array.from(pinInputs)
            .map((input) => input.value)
            .join("");

          if (pin.length !== 6) {
            showError("PIN deve ter 6 d√≠gitos");
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = "VERIFICANDO...";
          errorDiv.textContent = "";

          try {
            const result = await window.loginWithPin(pin);

            if (result.success) {
              submitBtn.textContent = "‚úì ACESSO LIBERADO";
              submitBtn.style.background = "#4caf50";
              // Login screen will be hidden by firebase-init-auth.js
            } else {
              showError(result.error || "PIN incorreto");
              submitBtn.disabled = false;
              submitBtn.textContent = "ENTRAR";

              // Clear inputs
              pinInputs.forEach((input) => {
                input.value = "";
                input.classList.remove("filled");
              });
              pinInputs[0].focus();
            }
          } catch (error) {
            showError("Erro ao fazer login");
            submitBtn.disabled = false;
            submitBtn.textContent = "ENTRAR";
          }
        }

        function showError(message) {
          errorDiv.textContent = message;
          errorDiv.style.color = "#f44336";

          // Shake animation
          pinInputs.forEach((input) => {
            input.style.animation = "shake 0.5s";
            setTimeout(() => {
              input.style.animation = "";
            }, 500);
          });
        }

        // Submit button click
        submitBtn.addEventListener("click", handleLogin);

        // Add shake animation
        const style = document.createElement("style");
        style.textContent = `
          @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
          }
        `;
        document.head.appendChild(style);
      })();
    </script>

    <!-- ================================================================
         SCRIPTS - ORDEM CR√çTICA COM AUTENTICA√á√ÉO!
         ================================================================ -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>

    <!-- Firebase Init com Autentica√ß√£o -->
    <script src="firebase-init-auth.js"></script>

    <!-- KDS Script -->
    <script src="kds.js"></script>

    <script>
      // Mostra sidebar quando o header for exibido pelo firebase-init-auth.js
      (function () {
        const header = document.querySelector(".kds-header");
        const sidebar = document.querySelector(".kds-sidebar");
        if (!header || !sidebar) return;

        const observer = new MutationObserver(function () {
          if (header.style.display && header.style.display !== "none") {
            sidebar.style.display = "flex";
          }
        });

        observer.observe(header, {
          attributes: true,
          attributeFilter: ["style"],
        });
      })();
    </script>
  </body>
</html>
